{% extends "base.html" %}

{% block title %}Take Exam - EYESH{% endblock %}

{% block content %}
<!-- Setup Section (shown initially) -->
<div id="setup-section">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Take an Exam</h1>
        <p class="text-gray-600">Generate a practice exam, answer questions, and see your score</p>
    </div>

    <div class="bg-white rounded-lg shadow p-8 max-w-xl mx-auto">
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Level</label>
                <select id="exam-level" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg p-3">
                    <option value="">All Levels</option>
                    <option value="beginner">Beginner (A1-A2)</option>
                    <option value="intermediate">Intermediate (B1-B2)</option>
                    <option value="advanced">Advanced (C1-C2)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Questions</label>
                <input type="number" id="exam-count" value="10" min="5" max="50" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg p-3">
            </div>
            <button onclick="startExam()" id="start-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 text-lg font-medium">
                Start Exam
            </button>
        </div>
    </div>
</div>

<!-- Exam Section (hidden initially) -->
<div id="exam-section" class="hidden">
    <!-- Progress Bar -->
    <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Progress</span>
            <span id="progress-text" class="text-sm text-gray-500">Question 1 of 10</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 10%"></div>
        </div>
    </div>

    <!-- Question Card -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <span id="question-number" class="font-bold text-lg text-gray-900">Question 1</span>
                <span id="question-level" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">-</span>
            </div>
        </div>

        <div class="px-6 py-8">
            <p id="question-sentence" class="text-xl mb-8">Loading...</p>

            <div id="options-container" class="space-y-3">
                <!-- Options will be rendered here -->
            </div>
        </div>

        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between">
            <button onclick="prevQuestion()" id="prev-question-btn" class="px-4 py-2 text-gray-600 hover:text-gray-900" disabled>
                &larr; Previous
            </button>
            <button onclick="nextQuestion()" id="next-question-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Next &rarr;
            </button>
            <button onclick="submitExam()" id="submit-btn" class="hidden px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium">
                Submit Exam
            </button>
        </div>
    </div>
</div>

<!-- Results Section (hidden initially) -->
<div id="results-section" class="hidden">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Exam Complete!</h1>
        <p class="text-gray-600">Here are your results</p>
    </div>

    <!-- Score Card -->
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-xl mx-auto mb-8">
        <div class="text-center">
            <div id="score-circle" class="w-32 h-32 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl font-bold">
                -
            </div>
            <p id="score-text" class="text-xl text-gray-600 mb-4">0 out of 0 correct</p>
            <div class="flex justify-center space-x-4">
                <button onclick="location.reload()" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Try Again
                </button>
                <a href="/" class="px-6 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Detailed Results -->
    <div id="results-details" class="space-y-4">
        <!-- Results will be rendered here -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let examData = null;
    let currentIndex = 0;
    let answers = {};

    async function startExam() {
        const btn = document.getElementById('start-btn');
        btn.disabled = true;
        btn.textContent = 'Generating Exam...';

        const level = document.getElementById('exam-level').value || null;
        const count = parseInt(document.getElementById('exam-count').value) || 10;

        try {
            examData = await API.generateExam({ count, level, mode: 'user' });
            answers = {};
            currentIndex = 0;

            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('exam-section').classList.remove('hidden');

            renderQuestion();
        } catch (e) {
            alert('Failed to generate exam: ' + e.message);
            btn.disabled = false;
            btn.textContent = 'Start Exam';
        }
    }

    function renderQuestion() {
        const q = examData.questions[currentIndex];
        const total = examData.questions.length;

        // Update progress
        document.getElementById('progress-text').textContent = `Question ${currentIndex + 1} of ${total}`;
        document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / total) * 100}%`;

        // Update question
        document.getElementById('question-number').textContent = `Question ${currentIndex + 1}`;
        document.getElementById('question-level').textContent = q.level;
        document.getElementById('question-sentence').textContent = q.sentence;

        // Render options
        const container = document.getElementById('options-container');
        container.innerHTML = Object.entries(q.options).sort().map(([letter, text]) => {
            const isSelected = answers[q.question_id] === letter;
            return `
                <button onclick="selectAnswer('${q.question_id}', '${letter}')"
                        class="w-full text-left p-4 rounded-lg border-2 transition-all ${isSelected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'}">
                    <span class="font-medium text-gray-700">${letter}.</span>
                    <span class="ml-2">${text}</span>
                </button>
            `;
        }).join('');

        // Update navigation buttons
        document.getElementById('prev-question-btn').disabled = currentIndex === 0;

        const isLast = currentIndex === total - 1;
        document.getElementById('next-question-btn').classList.toggle('hidden', isLast);
        document.getElementById('submit-btn').classList.toggle('hidden', !isLast);
    }

    function selectAnswer(questionId, letter) {
        answers[questionId] = letter;
        renderQuestion();
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
        }
    }

    function nextQuestion() {
        if (currentIndex < examData.questions.length - 1) {
            currentIndex++;
            renderQuestion();
        }
    }

    async function submitExam() {
        // Check if all questions are answered
        const unanswered = examData.questions.filter(q => !answers[q.question_id]);
        if (unanswered.length > 0) {
            if (!confirm(`You have ${unanswered.length} unanswered question(s). Submit anyway?`)) {
                return;
            }
        }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        try {
            const results = await API.submitExam({
                exam_id: examData.exam_id,
                answers: answers
            });

            displayResults(results);
        } catch (e) {
            alert('Failed to submit exam: ' + e.message);
            btn.disabled = false;
            btn.textContent = 'Submit Exam';
        }
    }

    function displayResults(results) {
        document.getElementById('exam-section').classList.add('hidden');
        document.getElementById('results-section').classList.remove('hidden');

        // Score circle color
        const scoreCircle = document.getElementById('score-circle');
        const percentage = results.score_percentage;
        if (percentage >= 80) {
            scoreCircle.className = 'w-32 h-32 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl font-bold bg-green-100 text-green-700';
        } else if (percentage >= 60) {
            scoreCircle.className = 'w-32 h-32 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl font-bold bg-yellow-100 text-yellow-700';
        } else {
            scoreCircle.className = 'w-32 h-32 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl font-bold bg-red-100 text-red-700';
        }
        scoreCircle.textContent = `${Math.round(percentage)}%`;

        document.getElementById('score-text').textContent = `${results.correct} out of ${results.total_questions} correct`;

        // Detailed results
        const container = document.getElementById('results-details');
        container.innerHTML = results.results.map((r, i) => {
            const q = examData.questions.find(q => q.question_id === r.question_id);
            return `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-3 ${r.is_correct ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Question ${i + 1}</span>
                            <span class="${r.is_correct ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${r.is_correct ? 'Correct' : 'Incorrect'}
                            </span>
                        </div>
                    </div>
                    <div class="px-6 py-4">
                        <p class="mb-3">${q.sentence}</p>
                        <div class="flex space-x-4 text-sm">
                            <span class="${r.is_correct ? 'text-green-600' : 'text-red-600'}">
                                Your answer: <strong>${r.user_answer || '(none)'}</strong>
                            </span>
                            ${!r.is_correct ? `<span class="text-green-600">Correct: <strong>${r.correct_answer}</strong></span>` : ''}
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 rounded text-sm text-blue-800">
                            <strong>Explanation:</strong> ${r.explanation}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>
{% endblock %}
